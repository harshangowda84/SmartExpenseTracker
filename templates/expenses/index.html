{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <!-- Enhanced Header Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="text-primary">ðŸ’° My Expenses Dashboard</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">My Expenses</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-right">
            <a href="{% url 'expenses:add-expenses' %}" class="btn btn-primary btn-lg mb-2 btn-pulse">
                <i class="fas fa-plus"></i> Add Expense
            </a>
            <br>
            <a href="{% url 'expenses:stats' %}" class="btn btn-outline-info">
                <i class="fas fa-chart-bar"></i> View Stats
            </a>
            <a href="/forecast/" class="btn btn-outline-success">
                <i class="fas fa-crystal-ball"></i> AI Forecast
            </a>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    {% if expenses.count %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Total Expenses</h5>
                    <h3>{{ expenses.count }}</h3>
                    <small>Transactions</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">This Month</h5>
                    <h3 id="monthlyTotal">-</h3>
                    <small>{{ currency }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Categories</h5>
                    <h3 id="categoryCount">-</h3>
                    <small>Unique</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Avg/Day</h5>
                    <h3 id="dailyAvg">-</h3>
                    <small>{{ currency }}</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% include 'partials/_messages.html' %}

    {% if expenses.count %}
    <!-- Enhanced Search and Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h6><i class="fas fa-search"></i> Search & Filter</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="searchField">Search Expenses</label>
                        <input type="text" class="form-control" id="searchField" 
                               placeholder="Search by description, category, or amount...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="dateFilter">Filter by Date</label>
                        <select class="form-control" id="dateFilter">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="categoryFilter">Filter by Category</label>
                        <select class="form-control" id="categoryFilter">
                            <option value="">All Categories</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Quick Filter Buttons -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="mb-2">
                        <small class="text-muted font-weight-bold">Quick Filters:</small>
                    </div>
                    <button class="btn btn-filter active" data-filter="all">All</button>
                    <button class="btn btn-filter" data-filter="today">Today</button>
                    <button class="btn btn-filter" data-filter="week">This Week</button>
                    <button class="btn btn-filter" data-filter="month">This Month</button>
                    <button class="btn btn-filter" data-filter="high">High Amount</button>
                    <button class="btn btn-filter" data-filter="recent">Most Recent</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Expenses Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6><i class="fas fa-list"></i> Expenses List</h6>
            <div class="btn-group btn-group-sm" role="group">
                <!-- Removed export CSV and print icons -->
            </div>
        </div>
        <div class="card-body">
            <div class="app-table">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>
                                    Amount ({{currency}})
                                    <a href="?sort=amount_asc{% if request.GET.page %}&page={{ request.GET.page }}{% endif %}" 
                                       class="text-light" data-toggle="tooltip" title="Sort Ascending">
                                        <i class="fas fa-sort-up"></i>
                                    </a>
                                    <a href="?sort=amount_desc{% if request.GET.page %}&page={{ request.GET.page }}{% endif %}" 
                                       class="text-light" data-toggle="tooltip" title="Sort Descending">
                                        <i class="fas fa-sort-down"></i>
                                    </a>
                                </th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>
                                    Date
                                    <a href="?sort=date_asc{% if request.GET.page %}&page={{ request.GET.page }}{% endif %}" 
                                       class="text-light" data-toggle="tooltip" title="Sort Ascending">
                                        <i class="fas fa-sort-up"></i>
                                    </a>
                                    <a href="?sort=date_desc{% if request.GET.page %}&page={{ request.GET.page }}{% endif %}" 
                                       class="text-light" data-toggle="tooltip" title="Sort Descending">
                                        <i class="fas fa-sort-down"></i>
                                    </a>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in page_obj %}
                            <tr>
                                <td>
                                    <strong class="text-primary">{{ expense.amount }}</strong>
                                </td>
                                <td>
                                    <span class="badge badge-secondary">{{ expense.category }}</span>
                                </td>
                                <td>{{ expense.description|truncatechars:50 }}</td>
                                <td>
                                    <small class="text-muted">{{ expense.date|date:"M d, Y" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'expenses:expense-edit' expense.id %}" 
                                           class="btn btn-outline-primary" data-toggle="tooltip" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- No Results Message -->
            <div class="no-results text-center py-4" style="display: none;">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No results found</h5>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>

            <!-- Search Results Table -->
            <div class="table-output" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Amount ({{currency}})</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Enhanced Pagination -->
            <div class="pagination-container mt-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="text-muted">
                            Showing page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            ({{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries)
                        </small>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Expense pagination">
                            <ul class="pagination justify-content-end mb-0">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if sort_order %}&sort={{ sort_order }}{% endif %}">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if sort_order %}&sort={{ sort_order }}{% endif %}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                                {% endif %}
                                
                                <li class="page-item active">
                                    <span class="page-link">{{ page_obj.number }}</span>
                                </li>
                                
                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if sort_order %}&sort={{ sort_order }}{% endif %}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if sort_order %}&sort={{ sort_order }}{% endif %}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-receipt fa-5x text-muted mb-4"></i>
            <h3 class="text-muted">No Expenses Yet</h3>
            <p class="text-muted mb-4">Start tracking your expenses to get insights into your spending habits.</p>
            <a href="{% url 'expenses:add-expenses' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i> Add Your First Expense
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this expense? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/searchExpenses.js' %}"></script>
<script>
// Calculate and display quick stats
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Calculate stats from current page data
    calculateStats();
    
    // Populate category filter
    populateCategoryFilter();
});

function calculateStats() {
    const rows = document.querySelectorAll('.app-table tbody tr');
    const categories = new Set();
    let monthlyTotal = 0;
    let totalAmount = 0;
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    rows.forEach(row => {
        const amountText = row.cells[0].textContent.trim();
        const amount = parseFloat(amountText) || 0;
        const categoryText = row.cells[1].textContent.trim();
        const dateText = row.cells[3].textContent.trim();
        const expenseDate = new Date(dateText);
        
        totalAmount += amount;
        categories.add(categoryText);
        
        if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
            monthlyTotal += amount;
        }
    });
    
    // Update display
    document.getElementById('categoryCount').textContent = categories.size;
    document.getElementById('monthlyTotal').textContent = monthlyTotal.toFixed(2);
    
    // Calculate daily average (simplified)
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const dailyAvg = monthlyTotal / daysInMonth;
    document.getElementById('dailyAvg').textContent = dailyAvg.toFixed(2);
}

function populateCategoryFilter() {
    const rows = document.querySelectorAll('.app-table tbody tr');
    const categories = new Set();
    const select = document.getElementById('categoryFilter');
    
    rows.forEach(row => {
        const categoryText = row.cells[1].textContent.trim();
        categories.add(categoryText);
    });
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
}

function confirmDelete(expenseId) {
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    deleteBtn.href = '/expense-delete/' + expenseId;
    $('#deleteModal').modal('show');
}

// Enhanced search functionality
document.getElementById('searchField').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.app-table tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    const noResults = document.querySelector('.no-results');
    if (visibleCount === 0 && searchTerm.length > 0) {
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
    }
});

// Category filter
document.getElementById('categoryFilter').addEventListener('change', function() {
    const selectedCategory = this.value;
    const rows = document.querySelectorAll('.app-table tbody tr');
    
    rows.forEach(row => {
        const categoryText = row.cells[1].textContent.trim();
        if (selectedCategory === '' || categoryText === selectedCategory) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Quick Filter Functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.btn-filter');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            applyQuickFilter(filter);
        });
    });
    
    function applyQuickFilter(filter) {
        const rows = document.querySelectorAll('.app-table tbody tr');
        
        rows.forEach(row => {
            let show = true;
            
            switch(filter) {
                case 'all':
                    show = true;
                    break;
                case 'today':
                    const today = new Date();
                    const rowDate = new Date(row.cells[3].textContent.trim());
                    show = rowDate.toDateString() === today.toDateString();
                    break;
                case 'week':
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const rowDateWeek = new Date(row.cells[3].textContent.trim());
                    show = rowDateWeek >= weekAgo;
                    break;
                case 'month':
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    const rowDateMonth = new Date(row.cells[3].textContent.trim());
                    show = rowDateMonth >= monthAgo;
                    break;
                case 'high':
                    const amount = parseFloat(row.cells[0].textContent.trim()) || 0;
                    show = amount > 100; // Adjust threshold as needed
                    break;
                case 'recent':
                    const threeDaysAgo = new Date();
                    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                    const rowDateRecent = new Date(row.cells[3].textContent.trim());
                    show = rowDateRecent >= threeDaysAgo;
                    break;
            }
            
            row.style.display = show ? '' : 'none';
        });
        
        // Update the regular filters to match
        if (filter === 'today' || filter === 'week' || filter === 'month') {
            document.getElementById('dateFilter').value = filter;
        } else {
            document.getElementById('dateFilter').value = '';
        }
    }
});
</script>

<style>
.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
    margin-bottom: 1.5rem;
}

.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s;
}

.badge {
    font-size: 0.8em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.pagination .page-link {
    border-radius: 50%;
    margin: 0 2px;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.no-results {
    padding: 3rem 0;
}
</style>

<!-- Floating Action Button -->
<a href="{% url 'expenses:add-expenses' %}" class="btn btn-primary btn-floating" data-toggle="tooltip" title="Quick Add Expense">
    <i class="fas fa-plus"></i>
</a>

{% endblock content %}