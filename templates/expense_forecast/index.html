{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h1 class="mt-4 mb-4">ðŸ¤– AI-Powered Expense Forecast</h1>
    
    {% include 'partials/_messages.html' %}
    
    {% if error %}
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle"></i> {{ error }}</h5>
        </div>
    {% endif %}
    
    {% if forecast_data and not error %}
        <!-- Enhanced Statistics Summary -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Expenses</h5>
                        <h3>â‚¹{{ total_expenses }}</h3>
                        <small>{{ expense_count }} transactions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Daily Average</h5>
                        <h3>â‚¹{{ avg_daily }}</h3>
                        <small>Current trend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">7-Day Average</h5>
                        <h3>â‚¹{{ recent_7_avg }}</h3>
                        <small>Recent spending</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center {% if trend_direction == 'increasing' %}bg-warning{% else %}bg-success{% endif %} text-white">
                    <div class="card-body">
                        <h5 class="card-title">Trend</h5>
                        <h3>{% if trend_direction == 'increasing' %}ðŸ“ˆ{% else %}ðŸ“‰{% endif %}</h3>
                        <small>{{ trend_direction|title }} {{ trend_percentage }}%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Forecast Total</h5>
                        <h3>â‚¹{{ total_forecast }}</h3>
                        <small>Next 30 days</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-dark text-white">
                    <div class="card-body">
                        <h5 class="card-title">Categories</h5>
                        <h3>{{ category_data|length }}</h3>
                        <small>Different types</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-crystal-ball"></i> 30-Day ML Forecast (Random Forest Model)</h5>
                        <small class="text-muted">Advanced AI predictions based on your spending patterns</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-sm">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Predicted Amount</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in forecast_data %}
                                    <tr>
                                        <td>{{ item.date }}</td>
                                        <td><span class="badge badge-secondary">{{ item.day }}</span></td>
                                        <td><strong>â‚¹{{ item.predicted_amount }}</strong></td>
                                        <td><span class="badge badge-primary">{{ item.category }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="thead-light">
                                    <tr>
                                        <th colspan="2">Total Predicted</th>
                                        <th>â‚¹{{ total_forecast }}</th>
                                        <th>Avg: â‚¹{{ avg_forecast }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-pie"></i> Category Analysis</h6>
                    </div>
                    <div class="card-body">
                        {% for category in category_data %}
                        <div class="mb-3 p-2 border rounded">
                            <h6 class="text-primary">{{ category.name }}</h6>
                            <div class="row">
                                <div class="col-6">
                                    <small><strong>Total:</strong> â‚¹{{ category.total }}</small><br>
                                    <small><strong>Average:</strong> â‚¹{{ category.average }}</small>
                                </div>
                                <div class="col-6">
                                    <small><strong>Count:</strong> {{ category.count }}</small><br>
                                    <small><strong>Share:</strong> {% widthratio category.total total_expenses 100 %}%</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                {% if monthly_data %}
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-calendar-alt"></i> Monthly Trends</h6>
                    </div>
                    <div class="card-body">
                        {% for month in monthly_data %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ month.month }}</span>
                            <strong>â‚¹{{ month.total }}</strong>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-tools"></i> AI Insights</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <small><strong>Model:</strong> Random Forest Regressor</small><br>
                            <small><strong>Features:</strong> Day patterns, category history, rolling averages</small><br>
                            <small><strong>Accuracy:</strong> Based on {{ expense_count }} historical records</small>
                        </div>
                        <a href="{% url 'add-expenses' %}" class="btn btn-primary btn-block mb-2">Add New Expense</a>
                        <a href="{% url 'expenses' %}" class="btn btn-secondary btn-block">View All Expenses</a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning">
            <h5><i class="fas fa-robot"></i> AI Forecast Not Available</h5>
            <p>The AI forecasting system needs at least <strong>5 expense entries</strong> to generate accurate predictions. Please add more expenses to unlock advanced ML-powered insights.</p>
            <a href="{% url 'add-expenses' %}" class="btn btn-primary">Add Expense Now</a>
        </div>
    {% endif %}
</div>

<style>
.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}