{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">ðŸ¤– AI-Powered Expense Forecast</h1>
        </div>
    </div>
    
    {% if error %}
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle"></i> {{ error }}</h5>
        </div>
    {% elif forecast_data %}
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Expenses</h5>
                        <h3>â‚¹{{ total_expenses }}</h3>
                        <small>{{ expense_count }} transactions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Daily Average</h5>
                        <h3>â‚¹{{ avg_daily }}</h3>
                        <small>Historical</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Recent Trend</h5>
                        <h3>â‚¹{{ recent_7_avg }}</h3>
                        <small>Last 7 days</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center {% if trend_direction == 'increasing' %}bg-warning{% elif trend_direction == 'decreasing' %}bg-success{% else %}bg-secondary{% endif %} text-white">
                    <div class="card-body">
                        <h5 class="card-title">Trend</h5>
                        <h3>{% if trend_direction == 'increasing' %}ðŸ“ˆ{% elif trend_direction == 'decreasing' %}ðŸ“‰{% else %}ðŸ“Š{% endif %}</h3>
                        <small>{{ trend_direction|title }} {{ trend_percentage }}%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">30-Day Forecast</h5>
                        <h3>â‚¹{{ total_forecast }}</h3>
                        <small>AI Prediction</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-dark text-white">
                    <div class="card-body">
                        <h5 class="card-title">ML Accuracy</h5>
                        <h3>{{ accuracy_score }}%</h3>
                        <small>Model Score</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Expense Trend & Forecast</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Category Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Forecast Breakdown -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-week"></i> Weekly Forecast Breakdown</h5>
                    </div>
                    <div class="card-body">
                        {% for week in weekly_forecasts %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div>
                                <strong>Week {{ week.week }}</strong><br>
                                <small class="text-muted">Daily Avg: â‚¹{{ week.avg_daily }}</small>
                            </div>
                            <div class="text-right">
                                <h5 class="mb-0 text-primary">â‚¹{{ week.total }}</h5>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tags"></i> Category Forecasts</h5>
                    </div>
                    <div class="card-body">
                        {% for category, data in category_forecasts.items %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div>
                                <strong>{{ category }}</strong><br>
                                <small class="text-muted">{{ data.count }} predictions â€¢ Avg: â‚¹{{ data.avg }}</small>
                            </div>
                            <div class="text-right">
                                <h5 class="mb-0 text-success">â‚¹{{ data.total }}</h5>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Forecast Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-crystal-ball"></i> 30-Day ML Forecast Details</h5>
                        <small class="text-muted">AI-powered predictions based on your spending patterns</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-sm">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Predicted Amount</th>
                                        <th>Category</th>
                                        <th>Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in forecast_data %}
                                    <tr>
                                        <td>{{ item.date }}</td>
                                        <td><span class="badge badge-secondary">{{ item.day }}</span></td>
                                        <td><strong class="text-primary">â‚¹{{ item.predicted_amount }}</strong></td>
                                        <td><span class="badge badge-info">{{ item.category }}</span></td>
                                        <td>
                                            <div class="progress" style="height: 15px;">
                                                <div class="progress-bar bg-success" style="width: {{ item.confidence }}%">
                                                    {{ item.confidence }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="thead-light">
                                    <tr>
                                        <th colspan="2">Total Predicted</th>
                                        <th class="text-primary">â‚¹{{ total_forecast }}</th>
                                        <th>Avg: â‚¹{{ avg_forecast }}</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ML Insights -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-brain"></i> AI Insights & Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-robot"></i> Model Information</h6>
                                    <small>
                                        <strong>Algorithm:</strong> Enhanced Pattern Recognition<br>
                                        <strong>Features:</strong> Day patterns, category trends, seasonality<br>
                                        <strong>Training Data:</strong> {{ expense_count }} historical records<br>
                                        <strong>Accuracy:</strong> {{ accuracy_score }}%
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-lightbulb"></i> Smart Recommendations</h6>
                                    <small>
                                        â€¢ Your spending trend is <strong>{{ trend_direction }}</strong><br>
                                        â€¢ Highest prediction category: Most frequent in your data<br>
                                        â€¢ Consider budgeting â‚¹{{ avg_forecast }} daily for next month<br>
                                        â€¢ {% if trend_direction == 'increasing' %}Monitor your increasing trend{% else %}Great spending control!{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="{% url 'add-expenses' %}" class="btn btn-primary mr-2">
                                <i class="fas fa-plus"></i> Add New Expense
                            </a>
                            <a href="{% url 'expenses' %}" class="btn btn-secondary">
                                <i class="fas fa-list"></i> View All Expenses
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <div class="alert alert-warning">
            <h5><i class="fas fa-robot"></i> AI Forecast Not Available</h5>
            <p>Need at least 5 expenses to generate ML predictions.</p>
            <a href="{% url 'add-expenses' %}" class="btn btn-primary">Add Expense Now</a>
        </div>
    {% endif %}
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Category Pie Chart
{% if category_chart_data %}
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for item in category_chart_data %}'{{ item.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in category_chart_data %}{{ item.value }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
                '#FF9F40', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Trend Line Chart
{% if trend_chart_data and forecast_chart_data %}
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        datasets: [{
            label: 'Historical Spending',
            data: [{% for item in trend_chart_data %}{ x: '{{ item.date }}', y: {{ item.amount }} }{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4
        }, {
            label: 'AI Forecast',
            data: [{% for item in forecast_chart_data %}{ x: '{{ item.date }}', y: {{ item.amount }} }{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#FF6384',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            borderDash: [5, 5],
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                type: 'time',
                time: {
                    parser: 'YYYY-MM-DD',
                    displayFormats: {
                        day: 'MMM DD'
                    }
                }
            },
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'â‚¹' + value;
                    }
                }
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});
{% endif %}
</script>

<style>
.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
    border: none;
}
.card:hover {
    transform: translateY(-2px);
}
.progress {
    border-radius: 10px;
}
.table th {
    border-top: none;
}
.badge {
    font-size: 0.8em;
}
</style>
{% endblock %}
